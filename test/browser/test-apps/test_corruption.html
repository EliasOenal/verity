<!DOCTYPE html>
<html>
<head>
    <title>Chat Cube Corruption Test</title>
</head>
<body>
    <h1>Chat Cube Corruption Test</h1>
    <div id="test-output"></div>
    <script src="/chat-test.js"></script>
    <script>
    async function testCubeCorruption() {
        const output = document.getElementById('test-output');
        
        // Wait for verity to be ready
        while (!window.verity) {
            await new Promise(resolve => setTimeout(resolve, 100));
        }
        
        output.innerHTML += '<p>Testing cube creation and parsing...</p>';
        
        // Create a test message
        const result = await window.verity.testUtils.sendMessage('Hello from test', 'testUser');
        output.innerHTML += `<p>Created cube: ${JSON.stringify(result)}</p>`;
        
        // Get the messages back
        const messages = window.verity.testUtils.getMessages();
        output.innerHTML += `<p>Retrieved messages: ${JSON.stringify(messages)}</p>`;
        
        // Check if content matches
        if (messages.messages.length > 0) {
            const msg = messages.messages[0];
            output.innerHTML += `<p>Message text: "${msg.text}"</p>`;
            output.innerHTML += `<p>Message sender: "${msg.sender}"</p>`;
            
            if (msg.text === 'Hello from test' && msg.sender === 'testUser') {
                output.innerHTML += '<p style="color:green">✓ No corruption detected</p>';
            } else {
                output.innerHTML += '<p style="color:red">✗ CORRUPTION DETECTED!</p>';
                output.innerHTML += `<p>Expected: "Hello from test" by "testUser"</p>`;
                output.innerHTML += `<p>Got: "${msg.text}" by "${msg.sender}"</p>`;
            }
        }
    }
    
    // Run test when page loads
    setTimeout(testCubeCorruption, 2000);
    </script>
</body>
</html>